<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SONAGED - Chatbot</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f6f7f9; }
      .app { max-width: 720px; margin: 0 auto; display: flex; flex-direction: column; height: 100vh; }
      header { padding: 12px 16px; background: #0f766e; color: #fff; display: flex; justify-content: space-between; align-items: center; }
      .connection-status { font-size: 12px; opacity: 0.8; }
      .connected { color: #10b981; }
      .disconnected { color: #f87171; }
      .messages { flex: 1; overflow-y: auto; padding: 16px; }
      .msg { max-width: 75%; margin: 8px 0; padding: 10px 12px; border-radius: 12px; line-height: 1.35; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
      .me { align-self: flex-end; background: #dcfce7; }
      .bot { align-self: flex-start; }
      .input { display: flex; gap: 8px; padding: 12px; background: #fff; border-top: 1px solid #e5e7eb; }
      input[type=text] { flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; }
      button { background: #0f766e; color: #fff; border: none; border-radius: 10px; padding: 10px 14px; font-size: 16px; cursor: pointer; transition: background 0.2s; }
      button:hover { background: #0d5d56; }
      button:disabled { background: #9ca3af; cursor: not-allowed; }
      .card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-top:8px; }
      .small { color:#6b7280; font-size:12px; }
      select { width: 100%; margin-top: 6px; padding: 8px; }
      input[type=url], input[type=file] { width: 100%; margin-top: 6px; padding: 8px; }

      /* Guides rapides am√©lior√©s */
      .guides-section { padding:12px; background:#fff; border-top:1px solid #e5e7eb; }
      .guide-tabs { display: flex; gap: 8px; margin-bottom: 12px; }
      .guide-tab { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; cursor: pointer; font-size: 14px; transition: all 0.2s; }
      .guide-tab.active { background: #0f766e; color: white; border-color: #0f766e; }
      .guide-content { display: none; }
      .guide-content.active { display: block; }
      
      /* Assistant guid√© */
      .guide-assistant { background: #f8fafc; border-radius: 8px; padding: 12px; }
      .guide-step { margin-bottom: 12px; }
      .guide-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
      .guide-buttons button { padding: 6px 12px; font-size: 14px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
      .guide-buttons button:hover { background: #e5e7eb; }
      .guide-input { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 4px; }

      /* Boutons rapides existants */
      .quick-buttons { display: flex; flex-wrap: wrap; gap: 6px; }
      .quick-buttons button { font-size: 14px; padding: 6px 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
      .quick-buttons button:hover { background: #e5e7eb; }

      /* Status indicators */
      .status { padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 14px; }
      .status-success { background: #d1fae5; color: #065f46; }
      .status-error { background: #fee2e2; color: #991b1b; }
      .status-warning { background: #fef3c7; color: #92400e; }
      .status-info { background: #dbeafe; color: #1e40af; }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div>
          <strong>Chatbot SONAGED</strong>
          <div style="font-size: 12px; opacity: 0.8;">Syst√®me de gestion des activit√©s</div>
        </div>
        <div id="connectionStatus" class="connection-status disconnected">
          ‚óè D√©connect√©
        </div>
      </header>

      <div id="chat" class="messages"></div>

      <!-- Section guides am√©lior√©e -->
      <div class="guides-section">
        <div class="guide-tabs">
          <div class="guide-tab active" data-tab="assistant">ü§ñ Assistant</div>
          <!-- <div class="guide-tab" data-tab="quick">‚ö° Rapide</div> -->
          <div class="guide-tab" data-tab="manual">‚úèÔ∏è Manuel</div>
        </div>

        <!-- Assistant guid√© -->
        <div id="assistant-guide" class="guide-content active">
          <div class="guide-assistant">
            <div id="guide-step" class="guide-step">
              <div style="font-weight: bold; margin-bottom: 8px;">D√©marrer une nouvelle d√©claration</div>
              <div style="color: #6b7280; font-size: 14px;">L'assistant va vous poser quelques questions pour cr√©er votre rapport</div>
            </div>
            <div id="guide-buttons" class="guide-buttons">
              <button onclick="startGuidedInput()">üöÄ Commencer</button>
            </div>
            <div id="guide-input-container" style="display: none; margin-top: 12px;">
              <input id="guide-input" class="guide-input" placeholder="Votre r√©ponse...">
              <button onclick="submitGuideInput()" style="margin-top: 8px; width: 100%;">Envoyer</button>
            </div>
          </div>
        </div>

        <!-- Boutons rapides -->
        <div id="quick-guide" class="guide-content">
          <div class="quick-buttons">
            <!-- <button type="button" class="guide" data-type="Mobilier urbain">üóëÔ∏è Mobilier urbain</button>
            <button type="button" class="guide" data-type="Collecte">üöõ Collecte</button> -->
            <button type="button" class="guide" data-type="Op√©rations sp√©ciales">üõ†Ô∏è Op√©rations sp√©ciales</button>
            <button type="button" class="guide" data-type="Anomalies">‚ö†Ô∏è Anomalies</button>
            <button type="button" class="guide" data-date="today">üìÖ Aujourd'hui</button>
            <button type="button" class="guide" data-date="yesterday">üìÖ Hier</button>
            <button type="button" id="insertModel">üìã Mod√®le</button>
          </div>
        </div>

        <!-- Mode manuel -->
        <div id="manual-guide" class="guide-content">
          <div style="font-size: 14px; color: #6b7280;">
            Tapez directement votre rapport dans le format :<br>
            <code>Situation [date] - [type] [zone] : [activit√©s]</code>
          </div>
        </div>
      </div>

      <div class="input">
        <input id="text" type="text" placeholder="D√©crivez votre situation ou utilisez l'assistant ci-dessus..."> 
        <button id="send">Envoyer</button>
      </div>
    </div>

    <script>
      const chat = document.getElementById('chat');
      const text = document.getElementById('text');
      const send = document.getElementById('send');
      const connectionStatus = document.getElementById('connectionStatus');

      let agents = [];
      let intentions = {}; // Charg√© depuis intentions.json
      let lastParsed = null;
      let selectedAgentId = null;
       let photoUrl = null;
       let geo = { lat: null, lng: null };
       let selectedTime = null; // HH:MM
      let selectedAgentInfo = null;
      let backendUrl = 'http://127.0.0.1:5000';

      // Guide state
      let guideStep = 0;
      let guideData = {};

      // Test de connexion au backend
      async function testConnection() {
        try {
          const response = await fetch(`${backendUrl}/agents`);
          if (response.ok) {
            connectionStatus.innerHTML = '‚óè Connect√©';
            connectionStatus.className = 'connection-status connected';
            return true;
          }
        } catch (e) {
          connectionStatus.innerHTML = '‚óè D√©connect√©';
          connectionStatus.className = 'connection-status disconnected';
          return false;
        }
      }

      function addMsg(content, who='bot') {
        const div = document.createElement('div');
        div.className = 'msg ' + (who === 'me' ? 'me' : 'bot');
        div.innerHTML = content;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      async function fetchJson(url, options) {
        const res = await fetch(url, options);
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const txt = await res.text();
          throw new Error(`R√©ponse non JSON (${res.status}): ${txt.substring(0,200)}`);
        }
        const data = await res.json();
        if (!res.ok) throw new Error(JSON.stringify(data));
        return data;
      }

      async function loadAgents() {
        try {
          const data = await fetchJson(`${backendUrl}/agents`);
          agents = data.items || [];
        } catch (e) {
          console.error('Erreur chargement agents:', e);
          addMsg('<div class="status status-error">‚ö†Ô∏è Impossible de charger la liste des agents</div>');
        }
      }

      async function loadIntentions() {
        try {
          const response = await fetch('./intentions.json');
          if (response.ok) {
            intentions = await response.json();
            console.log('Intentions charg√©es:', intentions);
          } else {
            console.warn('Fichier intentions.json non trouv√©, utilisation des donn√©es par d√©faut');
            // Donn√©es par d√©faut bas√©es sur votre structure
            intentions = {
              "mobilier_urbain": [
                "Nettoyage des bacs",
                "R√©fection des bacs", 
                "Installation de bacs",
                "Peinture de mobilier",
                "Lev√© de mobilier"
              ],
              "collecte": [
                "D√©but de collecte",
                "Fin de collecte",
                "Collecte non effectu√©e"
              ],
              "operations_speciales": [
                "Op√©ration coup de poing",
                "Nettoyage de march√©",
                "D√©sensablement",
                "D√©sinfection",
                "Grand nettoyage"
              ],
              "anomalies": [
                "Bac manquant",
                "Camion en panne",
                "D√©p√¥t sauvage",
                "Zone inaccessible"
              ]
            };
          }
        } catch (e) {
          console.error('Erreur chargement intentions:', e);
          // Utiliser les donn√©es par d√©faut en cas d'erreur
          intentions = {
            "mobilier_urbain": [
              "Nettoyage des bacs",
              "R√©fection des bacs",
              "Installation de bacs", 
              "Peinture de mobilier",
              "Lev√© de mobilier"
            ],
            "collecte": [
              "D√©but de collecte",
              "Fin de collecte",
              "Collecte non effectu√©e"
            ],
            "operations_speciales": [
              "Op√©ration coup de poing",
              "Nettoyage de march√©",
              "D√©sensablement",
              "D√©sinfection",
              "Grand nettoyage"
            ],
            "anomalies": [
              "Bac manquant",
              "Camion en panne",
              "D√©p√¥t sauvage", 
              "Zone inaccessible"
            ]
          };
        }
      }

      function renderParsed(parsed) {
        const act = Array.isArray(parsed.activites) ? parsed.activites.join(', ') : '';
        return `
          <div class="card">
            <div><strong>üìÖ Date:</strong> ${parsed.date || 'Non sp√©cifi√©e'}</div>
            <div><strong>üìç Zone:</strong> ${parsed.zone || 'Non sp√©cifi√©e'}</div>
            <div><strong>üè∑Ô∏è Type d'activit√©:</strong> ${parsed.type_activite || 'Non sp√©cifi√©'}</div>
            <div><strong>‚úÖ Activit√©s:</strong> ${act || 'Non sp√©cifi√©es'}</div>
            ${parsed.commentaire ? `<div><strong>üí¨ Commentaire:</strong> ${parsed.commentaire}</div>` : ''}
          </div>
        `;
      }

       function agentSelectorHtml() {
         // Champ heure identique √† daily.html: input type time libre
         const parsedHour = (lastParsed && lastParsed.heure) ? lastParsed.heure.substring(0,5) : '';
        return `
          <div class="card">
            <div style="font-weight: bold; margin-bottom: 8px;">üîê Identification Agent</div>
            <input id="matriculeInput" type="text" placeholder="Ex: whatsapp:+221770000001 ou MAT1234" style="width:100%;padding:8px;margin-top:6px;">
            <div class="small">Le syst√®me v√©rifiera que votre matricule existe dans la base</div>
            <div style="margin-top:8px">
              <button id="verifyBtn" type="button">V√©rifier</button> 
              <span id="verifyState" class="small"></span>
            </div>
            
            <hr style="margin:16px 0">

             <div style="font-weight: bold; margin-bottom: 8px;">üïí Heure du rapport (optionnel)</div>
             <input id="timeSelect" type="time" value="${parsedHour}" style="width:100%;padding:8px;">
             <div class="small">Par d√©faut: l'heure extraite du message si pr√©sente${parsedHour ? ` (d√©tect√©e: ${parsedHour})` : ''}.</div>
             
             <hr style="margin:16px 0">
            
            <div style="font-weight: bold; margin-bottom: 8px;">üì∏ Photo (optionnel)</div>
            <input id="photoUrl" type="url" placeholder="URL de l'image (ex: https://...)">
            <div class="small">ou</div>
            <input id="photoFile" type="file" accept="image/*">
            
            <hr style="margin:16px 0">
            
            <div style="font-weight: bold; margin-bottom: 8px;">üìç G√©olocalisation (optionnel)</div>
            <button id="geoBtn" type="button">üìç Ajouter ma position</button> 
            <span id="geoState" class="small"></span>
            
            <hr style="margin:16px 0">
            
            <button id="confirmBtn" disabled style="width: 100%; padding: 12px; font-size: 16px;">
              üíæ Enregistrer le rapport
            </button>
          </div>
        `;
      }

      async function onSend() {
        const val = text.value.trim();
        if (!val) return;
        
        addMsg(val, 'me');
        text.value = '';
        
        addMsg('<div class="status status-info">‚è≥ Analyse en cours...</div>');
        
        try {
          const parsed = await fetchJson(`${backendUrl}/rapport/parse`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({text: val})
          });
          
          lastParsed = parsed;
          addMsg("‚ú® <strong>Analyse termin√©e !</strong> Voici ce que j'ai compris :");
          addMsg(renderParsed(parsed));
          addMsg(agentSelectorHtml());
          
          setupAgentSelector();
        } catch (e) {
          addMsg(`<div class="status status-error">‚ùå Erreur: ${e.message}</div>`);
        }
      }

       function setupAgentSelector() {
        const verifyBtn = document.getElementById('verifyBtn');
        const verifyState = document.getElementById('verifyState');
        const matriculeInput = document.getElementById('matriculeInput');
        const confirmBtn = document.getElementById('confirmBtn');
         const timeSelect = document.getElementById('timeSelect');
        const photoUrlInput = document.getElementById('photoUrl');
        const photoFileInput = document.getElementById('photoFile');
        const geoBtn = document.getElementById('geoBtn');
        const geoState = document.getElementById('geoState');

         // Initialize time from parsed heure if exists
         if (lastParsed && lastParsed.heure) {
           const hhmm = lastParsed.heure.substring(0,5);
           selectedTime = hhmm;
           const opt = Array.from(timeSelect.options).find(o => o.value === hhmm);
           if (opt) timeSelect.value = hhmm;
         } else {
           selectedTime = null;
         }

         timeSelect.addEventListener('change', () => {
           selectedTime = timeSelect.value || null;
         });

        verifyBtn.addEventListener('click', async () => {
          selectedAgentId = null;
          confirmBtn.disabled = true;
          const matricule = matriculeInput.value.trim();
          
          if (!matricule) {
            verifyState.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Saisissez un matricule</span>';
            return;
          }
          
          verifyState.innerHTML = '<span style="color: #3b82f6;">üîç V√©rification...</span>';
          
          try {
            const res = await fetchJson(`${backendUrl}/agents?matricule=${encodeURIComponent(matricule)}`);
            const agent = (res.items || [])[0];
            
            if (agent) {
              selectedAgentId = agent.id;
              selectedAgentInfo = agent;
              verifyState.innerHTML = `<span style="color: #10b981;">‚úÖ Agent trouv√©: ${agent.nom}</span>`;
              confirmBtn.disabled = false;
            } else {
              verifyState.innerHTML = '<span style="color: #ef4444;">‚ùå Matricule introuvable</span>';
            }
          } catch (e) {
            verifyState.innerHTML = '<span style="color: #ef4444;">‚ùå Erreur de v√©rification</span>';
          }
        });

        confirmBtn.addEventListener('click', onConfirm);

        photoUrlInput.addEventListener('input', () => {
          photoUrl = photoUrlInput.value || null;
        });

        photoFileInput.addEventListener('change', async () => {
          const file = photoFileInput.files?.[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = () => {
            photoUrl = reader.result;
            addMsg('<div class="status status-success">üì∏ Photo ajout√©e avec succ√®s</div>');
          };
          reader.onerror = () => {
            addMsg('<div class="status status-error">‚ùå Impossible de lire le fichier image</div>');
          };
          reader.readAsDataURL(file);
        });

        async function getPrecisePosition({targetAccuracy=25, maxWaitMs=15000}={}){
          return new Promise((resolve, reject)=>{
            if (!navigator.geolocation) return reject(new Error('G√©olocalisation non disponible'));
            let best = null; let watchId = null; let done = false;
            const stop = ()=>{ if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } };
            const timer = setTimeout(()=>{ done=true; stop(); best? resolve(best): reject(new Error('Timeout localisation')); }, maxWaitMs);
            watchId = navigator.geolocation.watchPosition((pos)=>{
              const acc = pos.coords.accuracy || Infinity; // m√®tres
              if (!best || acc < (best.coords.accuracy||Infinity)) best = pos;
              if (acc <= targetAccuracy && !done){ done=true; clearTimeout(timer); stop(); resolve(pos); }
            }, (err)=>{ if (!done){ done=true; clearTimeout(timer); stop(); reject(err); } }, { enableHighAccuracy:true, maximumAge:0, timeout:maxWaitMs });
          });
        }

        geoBtn.addEventListener('click', async () => {
          geoState.innerHTML = '<span style="color: #3b82f6;">üìç Recherche d\'une position pr√©cise (‚â§25m)...</span>';
          try{
            const pos = await getPrecisePosition({ targetAccuracy:25, maxWaitMs:20000 });
            geo.lat = pos.coords.latitude;
            geo.lng = pos.coords.longitude;
            const acc = Math.round(pos.coords.accuracy||0);
            geoState.innerHTML = `<span style=\"color: #10b981;\">‚úÖ Position ajout√©e (${geo.lat.toFixed(5)}, ${geo.lng.toFixed(5)}) ‚Ä¢ pr√©cision ~${acc}m</span>`;
          }catch(err){
            geoState.innerHTML = `<span style=\"color: #ef4444;\">‚ùå ${err.message}</span>`;
          }
        });
      }

       async function onConfirm() {
        if (!selectedAgentId) {
          addMsg('<div class="status status-warning">‚ö†Ô∏è Veuillez v√©rifier votre matricule d\'agent avant d\'enregistrer</div>');
          return;
        }

        const payload = {
          agent_id: selectedAgentId,
          date_rapport: lastParsed?.date || null,
           heure_rapport: null,
          zone: lastParsed?.zone || null,
          type_activite: lastParsed?.type_activite || null,
          activites: lastParsed?.activites || [],
          commentaire: lastParsed?.commentaire || null
        };

         // Fill heure_rapport from selectedTime or parsed
         if (selectedTime) {
           payload.heure_rapport = selectedTime.length === 5 ? `${selectedTime}:00` : selectedTime;
         } else if (lastParsed && lastParsed.heure) {
           payload.heure_rapport = lastParsed.heure;
         }

        if (photoUrl) payload.photo_url = photoUrl;
        if (geo.lat && geo.lng) {
          payload.latitude = geo.lat;
          payload.longitude = geo.lng;
        }

        addMsg('<div class="status status-info">üíæ Enregistrement en cours...</div>');

        try {
          const res = await fetchJson(`${backendUrl}/rapport`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          addMsg(`<div class="status status-success">üéâ <strong>Rapport enregistr√© avec succ√®s !</strong><br>R√©f√©rence: #${res.id}</div>`);
          
          // Reset
          selectedAgentId = null;
          photoUrl = null;
          geo = { lat: null, lng: null };
          lastParsed = null;
          
        } catch (e) {
          addMsg(`<div class="status status-error">‚ùå √âchec de l'enregistrement: ${e.message}</div>`);
        }
      }

      // Event listeners
      send.addEventListener('click', onSend);
      text.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') onSend();
      });

      // Guide tabs
      document.querySelectorAll('.guide-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.guide-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.guide-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}-guide`).classList.add('active');
        });
      });

      // Fonctions utilitaires pour les guides
      function pad(n) { return n.toString().padStart(2,'0'); }
      function dateStr(d) { return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`; }
      function insertAtCursor(str) {
        const cur = text.selectionStart ?? text.value.length;
        const before = text.value.slice(0, cur);
        const after = text.value.slice(cur);
        text.value = before + str + after;
        text.focus();
        text.selectionStart = text.selectionEnd = (before + str).length;
      }
      function setModel() {
        const today = dateStr(new Date());
        text.value = `Situation ${today} - [Type] [Zone] : [Activit√©s]`;
        text.focus();
      }

      // Boutons rapides
      document.querySelectorAll('.guide').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.dataset.type) {
            insertAtCursor(` ${btn.dataset.type} `);
            return;
          }
          if (btn.dataset.date) {
            const now = new Date();
            if (btn.dataset.date === 'yesterday') now.setDate(now.getDate()-1);
            insertAtCursor(` ${dateStr(now)} `);
            return;
          }
        });
      });

      document.getElementById('insertModel').addEventListener('click', setModel);

      // Assistant guid√©
      const guideSteps = [
        {
          question: "Quelle est la date de votre activit√© ?",
          placeholder: "Ex: 19/09/25 ou aujourd'hui",
          buttons: [
            { text: "üìÖ Aujourd'hui", value: dateStr(new Date()) },
            { text: "üìÖ Hier", value: dateStr(new Date(Date.now() - 86400000)) }
          ]
        },
        {
          question: "Quel type d'activit√© avez-vous effectu√© ?",
          buttons: [
            // { text: "üóëÔ∏è Mobilier urbain", value: "mobilier_urbain" },
            // { text: "üöõ Collecte", value: "collecte" },
            { text: "üõ†Ô∏è Op√©rations sp√©ciales", value: "operations_speciales" },
            { text: "‚ö†Ô∏è Anomalies", value: "anomalies" }
          ]
        },
        {
          question: "Quelles activit√©s avez-vous r√©alis√©es ?",
          placeholder: "Ex: Installation de 5 poubelles, collecte de 2 tonnes de d√©chets...",
          type: "activities"
        },
        {
          question: "Dans quelle zone avez-vous travaill√© ?",
          placeholder: "Ex: Dakar Centre, Kaolack, Thi√®s...",
          type: "zone"
        },
        // {
        //   question: "√Ä quelle heure avez-vous termin√© ? (optionnel)",
        //   placeholder: "Ex: 08:00, 14:30...",
        //   type: "time",
        //   optional: true
        // }
      ];

      function startGuidedInput() {
        guideStep = 0;
        guideData = {};
        showGuideStep();
      }

      function showGuideStep() {
        if (guideStep >= guideSteps.length) {
          finishGuide();
          return;
        }

        const step = guideSteps[guideStep];
        const guideStepDiv = document.getElementById('guide-step');
        const guideButtonsDiv = document.getElementById('guide-buttons');
        const guideInputContainer = document.getElementById('guide-input-container');
        const guideInput = document.getElementById('guide-input');

        guideStepDiv.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px;">√âtape ${guideStep + 1}/${guideSteps.length}</div>
          <div style="color: #374151;">${step.question}</div>
          ${step.optional ? '<div style="color: #6b7280; font-size: 12px;">Cette √©tape est optionnelle</div>' : ''}
        `;

        guideButtonsDiv.innerHTML = '';
        
        // Si c'est l'√©tape des activit√©s et qu'on a choisi un type
        if (step.type === 'activities' && guideData.type) {
          const typeKey = guideData.type.toLowerCase().replace(' ', '_');
          const availableActivities = intentions[typeKey] || [];
          
          if (availableActivities.length > 0) {
            guideStepDiv.innerHTML += `
              <div style="color: #6b7280; font-size: 14px; margin-top: 8px;">
                S√©lectionnez une activit√© pour <strong>${getDisplayType(guideData.type)}</strong> :
              </div>
            `;
            
            // Cr√©er des boutons pour chaque activit√© disponible
            availableActivities.forEach(activity => {
              const button = document.createElement('button');
              button.textContent = `‚úì ${activity}`;
              button.style.width = '100%';
              button.style.marginBottom = '4px';
              button.style.textAlign = 'left';
              button.onclick = () => submitGuideValue(activity);
              guideButtonsDiv.appendChild(button);
            });
            
            // Ajouter un bouton pour saisie personnalis√©e
            const customButton = document.createElement('button');
            customButton.textContent = '‚úèÔ∏è Saisie personnalis√©e';
            customButton.style.background = '#f3f4f6';
            customButton.style.color = '#374151';
            customButton.onclick = () => {
              guideInputContainer.style.display = 'block';
              guideInput.focus();
            };
            guideButtonsDiv.appendChild(customButton);
            
            guideInputContainer.style.display = 'none';
          } else {
            // Pas d'activit√©s pr√©d√©finies, utiliser la saisie libre
            guideInputContainer.style.display = 'block';
            guideInput.focus();
          }
        } else if (step.type === 'time') {
          // √âtape heure avec bouton "Ignorer"
          const skipButton = document.createElement('button');
          skipButton.textContent = '‚è≠Ô∏è Ignorer cette √©tape';
          skipButton.style.background = '#f3f4f6';
          skipButton.style.color = '#374151';
          skipButton.onclick = () => {
            guideStep++;
            showGuideStep();
          };
          guideButtonsDiv.appendChild(skipButton);
          
          guideInput.placeholder = step.placeholder || 'Votre r√©ponse...';
          guideInput.value = '';
          guideInputContainer.style.display = 'block';
          guideInput.focus();
        } else {
          // √âtapes normales avec boutons pr√©d√©finis
          if (step.buttons) {
            step.buttons.forEach(btn => {
              const button = document.createElement('button');
              button.textContent = btn.text;
              button.onclick = () => submitGuideValue(btn.value);
              guideButtonsDiv.appendChild(button);
            });
          }

          guideInput.placeholder = step.placeholder || 'Votre r√©ponse...';
          guideInput.value = '';
          guideInputContainer.style.display = 'block';
          guideInput.focus();
        }
      }

      function getDisplayType(typeKey) {
        const typeDisplay = {
          'mobilier_urbain': 'Mobilier urbain',
          'collecte': 'Collecte',
          'operations_speciales': 'Op√©rations sp√©ciales',
          'anomalies': 'Anomalies'
        };
        return typeDisplay[typeKey] || typeKey;
      }

      function submitGuideInput() {
        const value = document.getElementById('guide-input').value.trim();
        if (value) {
          submitGuideValue(value);
        }
      }

      function submitGuideValue(value) {
        const stepNames = ['date', 'type', 'activites', 'zone', 'heure']; 
        guideData[stepNames[guideStep]] = value;
        guideStep++;
        showGuideStep();
      }

      function finishGuide() {
        // Construire le rapport dans le bon format
        const displayType = getDisplayType(guideData.type);
        
        // Format correct : Situation [date] - [type] [zone] : [activit√©s]
        // Si il y a une heure, l'ajouter √† la fin des activit√©s
        let activites = guideData.activites;
        if (guideData.heure) {
          activites += ` (${guideData.heure})`;
        }
        
        const rapport = `Situation ${guideData.date} - ${displayType} ${guideData.zone} : ${activites}`;
        text.value = rapport;
        
        document.getElementById('guide-step').innerHTML = `
          <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">‚úÖ Rapport g√©n√©r√© !</div>
          <div style="color: #374151; font-size: 14px;">Le rapport a √©t√© plac√© dans le champ de saisie. V√©rifiez le format avant d'envoyer.</div>
          <div style="background: #f3f4f6; padding: 8px; border-radius: 6px; margin-top: 8px; font-family: monospace; font-size: 13px;">
            ${rapport}
          </div>
          <div style="color: #6b7280; font-size: 12px; margin-top: 8px;">
            Format attendu : Situation [date] - [type] [zone] : [activit√©s]
          </div>
        `;
        
        document.getElementById('guide-buttons').innerHTML = `
          <button onclick="send.click()" style="background: #10b981;">üì§ Envoyer maintenant</button>
          <button onclick="startGuidedInput()">üîÑ Recommencer</button>
          <button onclick="editReport()" style="background: #f59e0b;">‚úèÔ∏è Modifier</button>
        `;
        
        document.getElementById('guide-input-container').style.display = 'none';
        text.focus();
      }

      function editReport() {
        text.focus();
        text.select();
      }

      // Initialisation
      testConnection().then(connected => {
        if (connected) {
          loadAgents();
          loadIntentions(); // Charger aussi les intentions
          addMsg('ü§ñ <strong>Bienvenue sur SONAGED !</strong><br>Je suis pr√™t √† vous aider.<br>Utilisez l\'assistant guid√© ou tapez directement votre rapport.');
        } else {
          addMsg('<div class="status status-error">‚ùå <strong>Connexion impossible au serveur</strong><br>V√©rifiez que votre backend Flask est d√©marr√© sur http://127.0.0.1:5000</div>');
          // Charger quand m√™me les intentions en mode offline
          loadIntentions();
        }
      });

      // Test de connexion p√©riodique
      setInterval(testConnection, 30000);
    </script>
  </body>
</html>